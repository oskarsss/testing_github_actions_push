import IntegrationProviderGrpcService from '@/@grpcServices/services/intergrations.service';
import { useTrailerLocation } from '@/store/streams/events/hooks';
import LocationComponents from '@/@core/ui-kits/loads/loads-map/controllers/load-info-controller/components/location-info/LocationComponents';
import { createSvgIcon } from '@mui/material';
import isOnline from '@/utils/is-online';
import { getLocationColor } from '@/@core/ui-kits/loads/loads-map/controllers/load-info-controller/utils';

const TrailerIcon = createSvgIcon(
    <svg
        width="14"
        height="14"
        viewBox="0 0 14 14"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
    >
        <path
            fillRule="evenodd"
            clipRule="evenodd"
            d="M13.3315 2.42137C13.3863 2.47606 13.4169 2.55025 13.4169 2.6276V10.2109C13.4169 10.2883 13.3863 10.3624 13.3315 10.4171C13.2768 10.4719 13.2026 10.5026 13.1253 10.5026H11.0836V11.0859C11.0836 11.1633 11.0529 11.2374 10.9982 11.2921C10.9435 11.3469 10.8693 11.3775 10.7919 11.3775C10.7146 11.3775 10.6404 11.3469 10.5857 11.2921C10.531 11.2374 10.5003 11.1633 10.5003 11.0859V10.5026H7.45533C7.53425 10.3179 7.57777 10.12 7.58366 9.91927C7.58611 9.71878 7.54633 9.52004 7.46699 9.33594C7.35493 9.07285 7.16798 8.8485 6.92945 8.69089C6.69087 8.53321 6.41128 8.44915 6.12533 8.44915C5.83938 8.44915 5.55973 8.53321 5.32119 8.69089C5.08265 8.8485 4.89571 9.07285 4.78365 9.33594C4.73165 9.52692 4.69651 9.7221 4.67865 9.91927C4.65516 9.72105 4.61218 9.52564 4.55031 9.33594C4.43628 9.07495 4.24863 8.85294 4.01033 8.69701C3.77203 8.54109 3.49343 8.45802 3.20865 8.45802C2.92387 8.45802 2.64528 8.54109 2.40697 8.69701C2.16867 8.85294 1.98102 9.07495 1.86699 9.33594H1.45866C1.3813 9.33594 1.30711 9.3052 1.25242 9.25048C1.19772 9.19576 1.16699 9.12162 1.16699 9.04427V2.6276C1.16699 2.55025 1.19772 2.47606 1.25242 2.42137C1.30711 2.36667 1.3813 2.33594 1.45866 2.33594H13.1253C13.2026 2.33594 13.2768 2.36667 13.3315 2.42137ZM3.50031 8.7526C3.40511 8.72717 3.30717 8.71346 3.20865 8.71177C3.00406 8.71195 2.80312 8.76596 2.626 8.86834C2.44887 8.97071 2.30178 9.11789 2.19949 9.2951C2.09454 9.47145 2.04006 9.67322 2.04199 9.87844C2.04199 10.1878 2.1649 10.4846 2.38369 10.7034C2.60248 10.9221 2.89923 11.0451 3.20865 11.0451C3.51806 11.0451 3.81481 10.9221 4.0336 10.7034C4.25239 10.4846 4.37531 10.1878 4.37531 9.87844C4.37724 9.67322 4.32276 9.47145 4.21781 9.2951C4.14007 9.1617 4.03661 9.04503 3.91345 8.95193C3.79028 8.85877 3.64986 8.79105 3.50031 8.7526ZM3.20865 10.3743C3.11058 10.3743 3.01472 10.3452 2.93318 10.2907C2.85164 10.2362 2.78809 10.1588 2.75056 10.0681C2.71303 9.97755 2.70321 9.87785 2.72235 9.78166C2.74147 9.68547 2.7887 9.59715 2.85804 9.5278C2.92739 9.45844 3.01573 9.41125 3.11192 9.39211C3.2081 9.37298 3.3078 9.38278 3.39839 9.42034C3.489 9.45785 3.56643 9.52138 3.62092 9.60293C3.6754 9.68448 3.70448 9.78032 3.70448 9.87844C3.70448 10.0099 3.65224 10.136 3.55925 10.229C3.46626 10.322 3.34015 10.3743 3.20865 10.3743ZM6.12533 8.71177C5.85944 8.71364 5.60219 8.80621 5.39614 8.97427C5.28145 9.06515 5.18622 9.17826 5.11614 9.30677C5.01119 9.48311 4.95671 9.68489 4.95864 9.8901C4.96328 10.1429 5.04994 10.3873 5.20555 10.5867C5.36118 10.786 5.57733 10.9293 5.82148 10.9951C6.06565 11.0609 6.32453 11.0456 6.55927 10.9515C6.79394 10.8574 6.99175 10.6897 7.12283 10.4734C7.22969 10.2973 7.28808 10.096 7.29199 9.8901C7.29392 9.68489 7.23943 9.48311 7.13449 9.30677C7.03363 9.1274 6.88722 8.97789 6.71 8.87341C6.53273 8.76888 6.33107 8.71311 6.12533 8.71177ZM6.12533 10.3743C6.02727 10.3743 5.93137 10.3452 5.84982 10.2907C5.7683 10.2362 5.70475 10.1588 5.66722 10.0681C5.62969 9.97755 5.61987 9.87785 5.639 9.78166C5.65813 9.68547 5.70535 9.59715 5.7747 9.5278C5.84404 9.45844 5.93242 9.41125 6.02855 9.39211C6.12474 9.37298 6.22443 9.38278 6.31503 9.42034C6.40568 9.45785 6.48308 9.52138 6.53757 9.60293C6.59205 9.68448 6.62116 9.78032 6.62116 9.87844C6.62116 10.0099 6.56889 10.136 6.47591 10.229C6.38293 10.322 6.25681 10.3743 6.12533 10.3743ZM9.92609 5.23598C9.76702 5.07686 9.55124 4.98746 9.32619 4.98746C9.10114 4.98746 8.88531 5.07686 8.72612 5.23598C8.56693 5.3951 8.47744 5.61092 8.47738 5.83594C8.47727 6.06099 8.56663 6.27682 8.72565 6.4359C8.88473 6.59503 9.1005 6.68445 9.32555 6.68445C9.55054 6.68445 9.76643 6.59503 9.92562 6.4359C10.0848 6.27682 10.1742 6.06099 10.1744 5.83594C10.1744 5.61092 10.0851 5.3951 9.92609 5.23598ZM6.99245 6.0481H7.42733C7.52241 6.9326 8.22848 7.63896 9.11298 7.73445L9.11287 8.16927H9.53707L9.53724 7.73445C10.4218 7.63896 11.1285 6.9326 11.2242 6.0481H11.6591L11.6593 5.62383H11.2244C11.1293 4.73928 10.4232 4.03291 9.5387 3.93746L9.53888 3.50261H9.11468L9.1145 3.93746C8.22988 4.03291 7.52328 4.73928 7.42744 5.62383H6.99263L6.99245 6.0481ZM8.27631 4.786C8.55491 4.50754 8.93262 4.3511 9.32643 4.3511C9.72023 4.3511 10.0979 4.50754 10.3762 4.786C10.6546 5.06446 10.8108 5.44214 10.8107 5.83594C10.8105 6.22975 10.654 6.60745 10.3754 6.88588C10.0968 7.16436 9.71907 7.32081 9.32532 7.32081C8.93151 7.32081 8.55386 7.16436 8.27549 6.88588C7.99718 6.60745 7.84085 6.22975 7.84103 5.83594C7.8412 5.44214 7.99777 5.06446 8.27631 4.786Z"
            fill="#596372"
        />
    </svg>,
    'TrailerIcon'
);

type Props = {
    trailer_id: string;
    flyToPoint: (lon: number, lat: number, zoom: number) => void;
};

export function LocationTrailerController({
    trailer_id,
    flyToPoint
}: Props) {
    const { data } = IntegrationProviderGrpcService.useGetIntegrationProvidersQuery({});
    const trailer_location = useTrailerLocation(trailer_id);
    const provider = data?.integrationProviders.find(
        (provider) => provider.id === trailer_location?.integrationProviderId
    );

    const is_online = isOnline(trailer_location?.timestamp);
    const locationColor = getLocationColor(trailer_location, is_online);

    const onClick = () => {
        flyToPoint(trailer_location?.lon, trailer_location?.lat, 15);
    };

    return (
        <LocationComponents.Row>
            <LocationComponents.IconContainer>
                <TrailerIcon />
            </LocationComponents.IconContainer>
            <LocationComponents.TitleColumn>
                {provider ? (
                    <LocationComponents.ProviderLogo
                        light_logo_url={provider.lightLogoUrl}
                        dark_logo_url={provider.darkLogoUrl}
                        provider_name={provider.name}
                    />
                ) : (
                    '-'
                )}
            </LocationComponents.TitleColumn>
            <LocationComponents.Location
                onClick={onClick}
                disabled={!trailer_location?.lon || !trailer_location?.lat}
                color={locationColor}
                location={trailer_location?.address}
            />
            <LocationComponents.Time time={trailer_location?.timestamp} />
        </LocationComponents.Row>
    );
}
